# 深海圈网站服务器部署执行手册

本文档详细记录部署步骤，每一步都有明确的操作指令和预期结果。

## 部署前准备

### 服务器信息
- IP地址：111.231.19.162
- 系统：Ubuntu（推测）
- 配置：4核8GB

### 需要的账号信息
- [ ] GitHub 账号
- [ ] 服务器 root 密码
- [ ] 域名（可选，暂时用IP访问）

## 第一步：准备代码仓库（5分钟）

### 1.1 创建 GitHub 仓库

**你需要操作：**
1. 登录你的 GitHub 账号
2. 创建新仓库，名称：`deepseacircle-website`（或你喜欢的名字）
3. 不要初始化 README

### 1.2 推送代码到 GitHub

**在本地终端执行：**
```bash
cd /Users/liyadong/Documents/GitHub/深海圈网站

# 初始化 git（如果还没有）
git init

# 添加远程仓库（替换为你的 GitHub 用户名）
git remote add origin https://github.com/YOUR_USERNAME/deepseacircle-website.git

# 添加所有文件
git add .

# 提交
git commit -m "Initial commit for deployment"

# 推送到 GitHub
git push -u origin main
```

**预期结果：** 
- GitHub 仓库中能看到所有项目文件

### 1.3 确认推送成功

**你需要操作：**
1. 访问你的 GitHub 仓库页面
2. 确认文件都已上传
3. 告诉我仓库地址

---

## 第二步：登录服务器（2分钟）

### 2.1 SSH 连接

**在本地终端执行：**
```bash
ssh root@111.231.19.162
```

**你需要操作：**
- 输入服务器密码

**预期结果：**
- 成功登录，看到类似 `root@hostname:~#` 的提示符

### 2.2 检查服务器环境

**在服务器上执行：**
```bash
# 检查系统版本
lsb_release -a

# 检查已安装的软件
node --version 2>/dev/null || echo "Node.js 未安装"
postgres --version 2>/dev/null || echo "PostgreSQL 未安装"
nginx -v 2>/dev/null || echo "Nginx 未安装"
```

**告诉我输出结果**

---

## 第三步：安装基础软件（10分钟）

### 3.1 更新系统

**在服务器上执行：**
```bash
apt update && apt upgrade -y
```

### 3.2 安装 Node.js 18

**在服务器上执行：**
```bash
# 添加 NodeSource 仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -

# 安装 Node.js
apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

**预期结果：**
- node 版本 18.x.x
- npm 版本 9.x.x

### 3.3 安装 PostgreSQL

**在服务器上执行：**
```bash
# 安装 PostgreSQL
apt-get install -y postgresql postgresql-contrib

# 启动 PostgreSQL
systemctl start postgresql
systemctl enable postgresql

# 检查状态
systemctl status postgresql
```

### 3.4 安装其他必要软件

**在服务器上执行：**
```bash
# 安装 Nginx
apt-get install -y nginx

# 安装 Git
apt-get install -y git

# 安装 PM2
npm install -g pm2

# 验证安装
pm2 --version
```

---

## 第四步：创建数据库（5分钟）

### 4.1 创建数据库和用户

**在服务器上执行：**
```bash
# 切换到 postgres 用户
sudo -u postgres psql
```

**在 PostgreSQL 命令行中执行：**
```sql
-- 创建数据库
CREATE DATABASE deepseacircle;

-- 创建用户
CREATE USER deepseauser WITH PASSWORD 'DeepSea@2024';

-- 授权
GRANT ALL PRIVILEGES ON DATABASE deepseacircle TO deepseauser;

-- 退出
\q
```

### 4.2 测试数据库连接

**在服务器上执行：**
```bash
# 测试连接
PGPASSWORD='DeepSea@2024' psql -U deepseauser -d deepseacircle -h localhost -c "SELECT version();"
```

**预期结果：** 显示 PostgreSQL 版本信息

---

## 第五步：部署项目（15分钟）

### 5.1 克隆项目

**在服务器上执行：**
```bash
# 创建项目目录
mkdir -p /var/www
cd /var/www

# 克隆项目（替换为你的 GitHub 地址）
git clone https://github.com/YOUR_USERNAME/deepseacircle-website.git deepseacircle

# 设置权限
chown -R www-data:www-data /var/www/deepseacircle
```

### 5.2 部署 Strapi CMS

**在服务器上执行：**
```bash
cd /var/www/deepseacircle/deepsea-cms

# 安装依赖
npm install

# 创建环境配置文件
cat > .env.production << 'EOF'
NODE_ENV=production
HOST=0.0.0.0
PORT=1337

# 生成随机密钥（重要！）
APP_KEYS=toBeModified1,toBeModified2,toBeModified3,toBeModified4
API_TOKEN_SALT=tobemodified
ADMIN_JWT_SECRET=tobemodified
JWT_SECRET=tobemodified

# 数据库配置
DATABASE_CLIENT=postgres
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=deepseacircle
DATABASE_USERNAME=deepseauser
DATABASE_PASSWORD=DeepSea@2024
EOF

# 生成随机密钥
node -e "console.log(require('crypto').randomBytes(16).toString('base64'))" # 记录这个值
```

**你需要操作：**
1. 记录生成的随机密钥
2. 编辑 .env.production，将所有 "tobemodified" 替换为不同的随机密钥

```bash
# 编辑环境文件
nano .env.production
# 按 Ctrl+X, Y, Enter 保存退出
```

### 5.3 构建并启动 Strapi

**在服务器上执行：**
```bash
# 构建 Strapi
NODE_ENV=production npm run build

# 创建 PM2 配置
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'strapi-cms',
    script: 'npm',
    args: 'start',
    cwd: '/var/www/deepseacircle/deepsea-cms',
    env: {
      NODE_ENV: 'production'
    }
  }]
};
EOF

# 启动 Strapi
pm2 start ecosystem.config.js

# 查看状态
pm2 status
pm2 logs strapi-cms --lines 20
```

**预期结果：** 
- PM2 显示 strapi-cms 状态为 online
- 日志显示 "Strapi is running"

### 5.4 部署 Next.js 前端

**在服务器上执行：**
```bash
cd /var/www/deepseacircle

# 安装依赖
npm install

# 创建环境配置
cat > .env.production.local << 'EOF'
# API 配置
NEXT_PUBLIC_STRAPI_URL=http://111.231.19.162:1337
NEXT_PUBLIC_SITE_URL=http://111.231.19.162

# 数据库配置
DATABASE_URL=postgresql://deepseauser:DeepSea@2024@localhost:5432/deepseacircle

# NextAuth 配置（如果需要）
NEXTAUTH_URL=http://111.231.19.162
NEXTAUTH_SECRET=your-nextauth-secret-key-here
EOF

# 构建项目
npm run build

# 创建 PM2 配置
cat > ecosystem.nextjs.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'nextjs-app',
    script: 'npm',
    args: 'start',
    cwd: '/var/www/deepseacircle',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
};
EOF

# 启动 Next.js
pm2 start ecosystem.nextjs.config.js

# 查看状态
pm2 status
pm2 logs nextjs-app --lines 20
```

---

## 第六步：配置 Nginx（5分钟）

### 6.1 配置反向代理

**在服务器上执行：**
```bash
# 创建 Nginx 配置
cat > /etc/nginx/sites-available/deepseacircle << 'EOF'
server {
    listen 80;
    server_name 111.231.19.162;

    # 前端
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Strapi 管理面板
    location /admin {
        proxy_pass http://localhost:1337/admin;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    # Strapi API
    location /api {
        proxy_pass http://localhost:1337/api;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;
    }

    # 上传文件
    location /uploads {
        proxy_pass http://localhost:1337/uploads;
    }

    client_max_body_size 100M;
}
EOF

# 启用配置
ln -s /etc/nginx/sites-available/deepseacircle /etc/nginx/sites-enabled/

# 删除默认配置
rm -f /etc/nginx/sites-enabled/default

# 测试配置
nginx -t

# 重启 Nginx
systemctl restart nginx
```

### 6.2 设置 PM2 开机自启

**在服务器上执行：**
```bash
# 保存 PM2 进程列表
pm2 save

# 设置开机自启
pm2 startup systemd -u root --hp /root
```

---

## 第七步：数据迁移（10分钟）

### 7.1 导出本地数据

**在本地终端执行：**
```bash
cd /Users/liyadong/Documents/GitHub/深海圈网站/deepsea-cms

# 导出 Strapi 数据库
pg_dump -h localhost -U postgres deepseacircle > strapi_backup.sql

# 打包上传文件
tar -czf uploads.tar.gz public/uploads

# 查看文件大小
ls -lh strapi_backup.sql uploads.tar.gz
```

### 7.2 上传到服务器

**在本地终端执行：**
```bash
# 上传文件到服务器
scp strapi_backup.sql root@111.231.19.162:/tmp/
scp uploads.tar.gz root@111.231.19.162:/tmp/
```

### 7.3 导入数据

**在服务器上执行：**
```bash
# 导入数据库
cd /tmp
sudo -u postgres psql deepseacircle < strapi_backup.sql

# 解压上传文件
cd /var/www/deepseacircle/deepsea-cms
tar -xzf /tmp/uploads.tar.gz

# 设置权限
chown -R www-data:www-data public/uploads

# 重启服务
pm2 restart all
```

---

## 第八步：测试验证（5分钟）

### 8.1 访问测试

**你需要操作：**
1. 打开浏览器访问：
   - 前端：http://111.231.19.162
   - Strapi管理：http://111.231.19.162/admin

2. 测试功能：
   - [ ] 首页能正常显示
   - [ ] 课程页面能正常访问
   - [ ] 视频能正常播放
   - [ ] Strapi 能正常登录

### 8.2 检查日志

**在服务器上执行：**
```bash
# 查看所有服务状态
pm2 status

# 查看日志
pm2 logs

# 查看 Nginx 错误日志
tail -f /var/log/nginx/error.log
```

---

## 故障排查

### 如果网站无法访问

1. 检查防火墙
```bash
# 查看防火墙状态
ufw status

# 如果启用了，开放端口
ufw allow 80
ufw allow 443
ufw allow 22
```

2. 检查服务状态
```bash
pm2 status
systemctl status nginx
systemctl status postgresql
```

3. 查看错误日志
```bash
pm2 logs --lines 50
journalctl -u nginx -n 50
```

---

## 后续优化

1. **配置域名**（如果有）
2. **配置 HTTPS**（使用 Let's Encrypt）
3. **配置备份**（定期备份数据库和文件）
4. **配置监控**（使用 PM2 监控或其他工具）

---

## 需要帮助？

在执行过程中遇到任何问题，请：
1. 复制错误信息
2. 告诉我在哪一步出现问题
3. 我们一起解决！