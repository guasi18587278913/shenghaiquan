# 数据质量管理方案

## 🔍 问题分析

### 当前问题
1. **原始数据缺失**：CSV文件中很多用户没有城市信息
2. **随机分配错误**：之前的修复脚本随机分配城市，导致数据不准确
3. **缺乏验证机制**：没有数据准确性的验证流程
4. **无法追溯**：修改后无法知道哪些数据是推断的，哪些是真实的

### 根本原因
- 数据收集时未强制要求填写城市
- 缺乏数据质量控制流程
- 修复脚本过于简单粗暴

## 🛠️ 解决方案

### 1. 智能数据修复
```bash
# 运行智能修复脚本
node scripts/fix-user-locations-smart.js
```

**智能推断逻辑**：
1. **已知映射表**：维护准确的用户-城市映射
2. **Bio文本分析**：从个人简介中提取城市信息
3. **公司推断**：根据公司总部位置推断
4. **地址解析**：从phone字段的地址信息提取
5. **哈希分配**：无法推断时基于ID哈希值分配（保证一致性）

### 2. 数据质量保障机制

#### A. 数据收集阶段
```javascript
// 新用户注册时的验证
const userSchema = {
  name: { required: true },
  location: { 
    required: true,
    validate: (value) => validCities.includes(value)
  }
}
```

#### B. 数据导入阶段
```javascript
// 导入时的数据增强
async function enhanceUserData(rawData) {
  // 1. 尝试从多个字段推断位置
  const location = inferLocation(rawData)
  
  // 2. 标记数据来源
  return {
    ...rawData,
    location,
    locationSource: location ? 'inferred' : 'default',
    dataQuality: calculateQualityScore(rawData)
  }
}
```

#### C. 数据审计追踪
```javascript
// 添加数据质量字段到数据库
model User {
  // ... 现有字段
  locationSource    String?  @default("original") // original, inferred, manual, default
  locationConfidence Float?  @default(1.0)       // 0-1的置信度
  lastVerified      DateTime?                    // 最后验证时间
}
```

### 3. 持续改进流程

#### A. 用户自主更新
```typescript
// 在个人资料页面突出显示
{locationSource === 'inferred' && (
  <Alert>
    <AlertCircle className="h-4 w-4" />
    <AlertDescription>
      您的城市信息是系统推断的，请确认是否正确
      <Button onClick={() => setShowCityPicker(true)}>
        更新城市
      </Button>
    </AlertDescription>
  </Alert>
)}
```

#### B. 管理员工具
```typescript
// 管理后台的数据质量仪表板
export function DataQualityDashboard() {
  return (
    <div>
      <h2>数据质量概览</h2>
      <Stats>
        <Stat label="准确位置" value={accurateCount} />
        <Stat label="推断位置" value={inferredCount} />
        <Stat label="需要确认" value={unverifiedCount} />
      </Stats>
      
      <UserList filter="needsVerification" />
    </div>
  )
}
```

### 4. 预防措施

#### A. 强制字段
```javascript
// 新用户注册/导入时
const requiredFields = ['name', 'email', 'location']
const optionalButImportant = ['company', 'position', 'skills']
```

#### B. 数据验证规则
```javascript
const validationRules = {
  location: {
    type: 'enum',
    values: VALID_CITIES,
    fallback: 'ask_user' // 不要随机分配
  }
}
```

#### C. 定期数据审查
```javascript
// 每月运行数据质量检查
async function monthlyDataAudit() {
  const report = await generateQualityReport()
  
  // 发送给管理员
  await sendAuditReport(report)
  
  // 提醒用户更新
  await notifyUsersWithLowQualityData()
}
```

## 📋 实施步骤

### 立即执行
1. **修复杨昌的数据**
   ```bash
   sqlite3 prisma/dev.db "UPDATE User SET location='北京' WHERE name='杨昌';"
   ```

2. **运行智能修复脚本**
   ```bash
   node scripts/fix-user-locations-smart.js
   ```

3. **添加已知映射**
   ```javascript
   // 在脚本中添加
   const knownUserCities = {
     '杨昌': '北京',
     // 添加更多已知的正确映射
   }
   ```

### 短期改进（1-2周）
1. 创建用户资料完善提醒功能
2. 添加管理员数据审核界面
3. 实现数据质量评分系统

### 长期规划（1-3月）
1. 机器学习模型提高推断准确率
2. 用户互助验证机制
3. 数据质量自动化监控

## 🎯 预期效果

1. **数据准确率提升**：从随机分配到智能推断
2. **可追溯性**：知道每个数据的来源和可信度
3. **持续改进**：用户参与数据完善
4. **预防为主**：从源头控制数据质量

## 🔧 维护建议

1. **定期更新映射表**：收集用户反馈，更新knownUserCities
2. **优化推断算法**：根据准确率调整推断逻辑
3. **数据质量报告**：每月生成并分析
4. **用户激励**：鼓励用户完善个人信息

通过这套方案，可以从根本上解决数据质量问题，而不是简单的"头痛医头"。