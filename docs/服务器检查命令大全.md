# 深海圈网站 - 服务器检查命令大全

## 一、连接服务器

```bash
# 连接到服务器
ssh root@111.231.19.162

# 如果是第一次连接，输入 yes
# 然后输入服务器密码
```

## 二、环境检查命令

### 2.1 检查软件版本

```bash
# 检查 Node.js 版本（应该是 v18 或更高）
node -v

# 检查 npm 版本
npm -v

# 检查 PM2 版本
pm2 -v

# 检查 Git 版本
git --version

# 检查 PostgreSQL 版本
psql --version
```

### 2.2 检查服务状态

```bash
# 检查 PostgreSQL 数据库状态
sudo systemctl status postgresql

# 检查 Nginx 状态
sudo systemctl status nginx

# 检查 Redis 状态（如果安装了）
sudo systemctl status redis

# 退出查看状态（按 q 键）
```

## 三、项目检查命令

### 3.1 进入项目目录

```bash
# 进入网站根目录
cd /www/wwwroot

# 查看目录内容
ls -la

# 进入深海圈项目目录
cd shenghaiquan

# 查看项目文件
ls -la
```

### 3.2 检查项目配置

```bash
# 查看环境变量文件
cat .env
# 或
cat .env.production

# 检查 package.json
cat package.json

# 检查是否已构建
ls -la .next/

# 检查 node_modules 是否存在
ls -la node_modules/
```

### 3.3 检查 Git 状态

```bash
# 查看当前分支
git branch

# 查看远程仓库
git remote -v

# 查看最近的提交
git log --oneline -5
```

## 四、进程和端口检查

### 4.1 PM2 进程管理

```bash
# 查看 PM2 进程列表
pm2 list

# 查看详细信息
pm2 show shenghaiquan

# 查看日志（最近50行）
pm2 logs shenghaiquan --lines 50

# 查看错误日志
pm2 logs shenghaiquan --err --lines 50

# 查看实时日志
pm2 logs shenghaiquan
# 按 Ctrl+C 退出
```

### 4.2 端口检查

```bash
# 检查 3000 端口（Node.js）
netstat -tlnp | grep 3000

# 检查 8888 端口（Nginx）
netstat -tlnp | grep 8888

# 检查 5432 端口（PostgreSQL）
netstat -tlnp | grep 5432

# 查看所有监听端口
netstat -tlnp
```

## 五、数据库检查

### 5.1 PostgreSQL 检查

```bash
# 切换到 postgres 用户
sudo -u postgres psql

# 在 PostgreSQL 命令行中：
\l                    # 列出所有数据库
\c shenghaiquan      # 连接到深海圈数据库
\dt                  # 列出所有表
\q                   # 退出

# 一行命令查看数据库
sudo -u postgres psql -c "\l"
```

### 5.2 使用 Prisma 检查数据库

```bash
# 进入项目目录
cd /www/wwwroot/shenghaiquan

# 查看数据库状态
npx prisma db push --preview-feature

# 查看数据库内容
npx prisma studio
# 会在 5555 端口打开，按 Ctrl+C 关闭
```

## 六、网站访问测试

### 6.1 本地测试

```bash
# 测试 Node.js 应用
curl http://localhost:3000

# 测试 Nginx
curl http://localhost:8888

# 只看 HTTP 状态码
curl -I http://localhost:3000

# 测试 API 接口
curl http://localhost:3000/api/users
```

### 6.2 防火墙检查

```bash
# 查看防火墙状态
sudo ufw status

# 查看防火墙规则（详细）
sudo ufw status verbose

# 开放端口（如果需要）
sudo ufw allow 8888
sudo ufw allow 22
```

## 七、日志查看

### 7.1 应用日志

```bash
# PM2 日志位置
ls -la ~/.pm2/logs/

# 查看应用输出日志
tail -f ~/.pm2/logs/shenghaiquan-out.log

# 查看应用错误日志
tail -f ~/.pm2/logs/shenghaiquan-error.log
```

### 7.2 系统日志

```bash
# Nginx 访问日志
tail -f /var/log/nginx/access.log

# Nginx 错误日志
tail -f /var/log/nginx/error.log

# 系统日志
tail -f /var/log/syslog
```

### 7.3 Webhook 日志

```bash
# 查看 webhook 日志
cat /www/wwwroot/webhook.log

# 实时查看 webhook 日志
tail -f /www/wwwroot/webhook.log
```

## 八、常用操作命令

### 8.1 启动/停止/重启

```bash
# PM2 操作
pm2 start shenghaiquan      # 启动
pm2 stop shenghaiquan       # 停止
pm2 restart shenghaiquan    # 重启
pm2 reload shenghaiquan     # 平滑重启

# 如果 PM2 没有进程，手动启动
cd /www/wwwroot/shenghaiquan
pm2 start npm --name shenghaiquan -- start

# 服务操作
sudo systemctl start nginx      # 启动 Nginx
sudo systemctl stop nginx       # 停止 Nginx
sudo systemctl restart nginx    # 重启 Nginx
sudo systemctl restart postgresql # 重启数据库
```

### 8.2 更新代码

```bash
cd /www/wwwroot/shenghaiquan

# 拉取最新代码
git pull origin main

# 安装依赖
npm install

# 构建项目
npm run build

# 重启应用
pm2 restart shenghaiquan
```

### 8.3 查看资源使用

```bash
# 查看 CPU 和内存使用
top
# 按 q 退出

# 查看磁盘使用
df -h

# 查看内存使用
free -h

# PM2 监控
pm2 monit
```

## 九、一键检查脚本

### 9.1 基础检查脚本

```bash
#!/bin/bash
echo "====== 深海圈网站状态检查 ======"
echo ""
echo "1. 检查Node.js："
if command -v node &> /dev/null; then
    echo "✅ Node.js已安装，版本：$(node -v)"
else
    echo "❌ Node.js未安装"
fi
echo ""
echo "2. 检查PM2："
if command -v pm2 &> /dev/null; then
    echo "✅ PM2已安装，版本：$(pm2 -v)"
    echo "   运行中的进程："
    pm2 list
else
    echo "❌ PM2未安装"
fi
echo ""
echo "3. 检查项目目录："
if [ -d "/www/wwwroot/shenghaiquan" ]; then
    echo "✅ 项目目录存在"
    cd /www/wwwroot/shenghaiquan
    if [ -f ".env" ] || [ -f ".env.production" ]; then
        echo "✅ 环境变量文件存在"
    else
        echo "❌ 环境变量文件缺失"
    fi
    if [ -d ".next" ]; then
        echo "✅ 项目已构建"
    else
        echo "❌ 项目未构建"
    fi
else
    echo "❌ 项目目录不存在"
fi
echo ""
echo "4. 检查数据库："
if systemctl is-active --quiet postgresql; then
    echo "✅ PostgreSQL正在运行"
else
    echo "❌ PostgreSQL未运行"
fi
echo ""
echo "5. 检查Nginx："
if systemctl is-active --quiet nginx; then
    echo "✅ Nginx正在运行"
else
    echo "❌ Nginx未运行"
fi
echo ""
echo "6. 测试网站访问："
if curl -s http://localhost:3000 > /dev/null; then
    echo "✅ 网站程序正在运行"
else
    echo "❌ 网站程序未运行"
fi
echo ""
echo "7. 端口监听状态："
echo "端口 3000 (Node.js):"
netstat -tlnp | grep 3000 || echo "❌ 未监听"
echo "端口 8888 (Nginx):"
netstat -tlnp | grep 8888 || echo "❌ 未监听"
echo ""
echo "====== 检查完成 ======"
```

### 9.2 详细诊断脚本

```bash
#!/bin/bash
echo "====== 深海圈网站详细诊断 ======"
echo ""
echo "=== 系统信息 ==="
echo "系统版本: $(lsb_release -d | cut -f2)"
echo "内核版本: $(uname -r)"
echo "当前时间: $(date)"
echo "运行时长: $(uptime -p)"
echo ""
echo "=== 资源使用 ==="
echo "CPU使用率: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')%"
echo "内存使用: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
echo "磁盘使用: $(df -h / | tail -1 | awk '{print $3 "/" $2 " (" $5 ")"}')"
echo ""
echo "=== 网络连接 ==="
echo "活动连接数: $(netstat -an | grep ESTABLISHED | wc -l)"
echo "监听端口:"
netstat -tlnp | grep -E ':(22|80|443|3000|5432|8888)\s' | awk '{print $4 " <- " $7}'
echo ""
echo "=== 应用状态 ==="
if [ -d "/www/wwwroot/shenghaiquan" ]; then
    cd /www/wwwroot/shenghaiquan
    echo "Git分支: $(git branch --show-current)"
    echo "最后提交: $(git log -1 --oneline)"
    echo "PM2进程:"
    pm2 describe shenghaiquan | grep -E '(status|uptime|restarts)'
fi
echo ""
echo "====== 诊断完成 ======"
```

## 十、故障排除命令

### 10.1 如果网站打不开

```bash
# 1. 检查进程
pm2 list

# 2. 如果没有进程，启动它
cd /www/wwwroot/shenghaiquan
pm2 start npm --name shenghaiquan -- start

# 3. 查看错误日志
pm2 logs shenghaiquan --err --lines 100

# 4. 检查端口
netstat -tlnp | grep -E '3000|8888'

# 5. 检查防火墙
sudo ufw status
```

### 10.2 如果数据库连接失败

```bash
# 1. 检查PostgreSQL服务
sudo systemctl status postgresql

# 2. 如果没运行，启动它
sudo systemctl start postgresql

# 3. 测试连接
cd /www/wwwroot/shenghaiquan
npx prisma db push

# 4. 查看数据库日志
sudo tail -f /var/log/postgresql/postgresql-*.log
```

### 10.3 如果自动部署失败

```bash
# 1. 测试部署脚本
cd /www/wwwroot/shenghaiquan
bash deploy-webhook.sh

# 2. 查看webhook日志
tail -f /www/wwwroot/webhook.log

# 3. 检查脚本权限
ls -la deploy-webhook.sh
# 如果没有执行权限
chmod +x deploy-webhook.sh

# 4. 手动更新
git pull origin main
npm install
npm run build
pm2 restart shenghaiquan
```

## 十一、安全退出

```bash
# 退出数据库命令行
\q

# 退出日志查看
Ctrl + C

# 退出服务器
exit
# 或
logout
```

---

**提示：**
1. 所有命令都可以安全运行，不会损坏系统
2. 如果不确定，可以先用 `man 命令名` 查看帮助
3. 遇到问题随时截图问我