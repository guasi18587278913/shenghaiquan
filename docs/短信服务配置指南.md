# 短信服务配置指南

## 概述
本指南将帮助您配置腾讯云短信服务，实现手机验证码登录功能。

## 配置步骤

### 1. 开通腾讯云短信服务

1. 登录[腾讯云控制台](https://console.cloud.tencent.com/)
2. 搜索"短信"或"SMS"
3. 点击"立即开通"
4. 按照提示完成实名认证

### 2. 创建短信签名

1. 进入短信控制台
2. 点击"国内短信" → "签名管理" → "创建签名"
3. 填写信息：
   - 签名类型：选择"网站"
   - 签名内容：深海圈
   - 申请说明：用于深海圈网站用户登录验证
4. 提交审核（通常1-2小时）

### 3. 创建短信模板

1. 点击"模板管理" → "创建模板"
2. 填写信息：
   - 模板名称：登录验证码
   - 短信类型：验证码
   - 模板内容：`您的验证码是{1}，{2}分钟内有效，请勿泄露给他人。`
3. 提交审核

### 4. 获取应用信息

1. 在"应用管理"中查看：
   - SDKAppID
   - AppKey

2. 在"访问管理"获取：
   - SecretId
   - SecretKey

### 5. 配置环境变量

在 `.env.local` 文件中添加：

```env
# 腾讯云短信配置
TENCENT_SECRET_ID=你的SecretId
TENCENT_SECRET_KEY=你的SecretKey
SMS_SDK_APP_ID=你的SDKAppID
SMS_SIGN_NAME=深海圈
SMS_TEMPLATE_ID=你的模板ID
```

### 6. 安装SDK

```bash
npm install tencentcloud-sdk-nodejs-sms
```

### 7. 更新发送验证码代码

在 `/app/api/auth/send-code/route.ts` 中，取消注释短信发送代码：

```typescript
import { sms } from "tencentcloud-sdk-nodejs-sms";

const SmsClient = sms.v20210111.Client;

// 在发送验证码的地方
const smsClient = new SmsClient({
  credential: {
    secretId: process.env.TENCENT_SECRET_ID,
    secretKey: process.env.TENCENT_SECRET_KEY,
  },
  region: "ap-guangzhou",
});

await smsClient.SendSms({
  PhoneNumberSet: [`+86${phone}`],
  SmsSdkAppId: process.env.SMS_SDK_APP_ID,
  SignName: process.env.SMS_SIGN_NAME,
  TemplateId: process.env.SMS_TEMPLATE_ID,
  TemplateParamSet: [code, "5"],
});
```

## 费用说明

- 国内短信：约 0.045 元/条
- 套餐包：
  - 1000条：40元
  - 10000条：400元
  - 建议先购买小套餐包测试

## 安全建议

1. **限制发送频率**
   - 同一手机号60秒内只能发送一次
   - 每日发送上限（如10条）

2. **验证码安全**
   - 6位数字随机生成
   - 5分钟有效期
   - 使用后立即失效

3. **防止恶意调用**
   - 添加图形验证码
   - IP限制
   - 请求签名验证

## 生产环境部署

1. 使用 Redis 存储验证码（替代内存存储）
2. 添加日志记录
3. 监控短信发送成功率
4. 设置异常告警

## 常见问题

### Q: 签名审核不通过？
A: 确保签名与网站名称一致，提供网站备案信息。

### Q: 模板审核不通过？
A: 避免营销内容，模板要简洁明了。

### Q: 发送失败？
A: 检查手机号格式、余额是否充足、配置是否正确。

## 测试方法

开发环境下，验证码会在控制台显示，无需真实发送短信。