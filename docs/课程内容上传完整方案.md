# 深海圈课程内容上传完整方案

## 一、当前系统分析

### 现有功能
1. **数据库结构**：已有完整的课程数据模型（CourseSection → Course → Chapter → Lesson）
2. **上传API**：已有基础的图片上传功能（`/api/upload`）
3. **管理界面**：已有简单的课程管理界面（`/admin/courses`）
4. **存储方式**：
   - 文字内容：直接存储在数据库 `content` 字段（支持Markdown）
   - 图片：本地存储在 `public/uploads/images`
   - 视频：使用腾讯云点播的 `videoId`

## 二、完整上传方案

### 1. 文字内容上传

**存储方式**：
- 直接存储在数据库的 `Lesson.content` 字段
- 支持 Markdown 格式，可以包含标题、列表、代码块、表格等

**实施步骤**：
```markdown
1. 在管理界面使用 Markdown 编辑器
2. 直接输入或粘贴文字内容
3. 支持实时预览
4. 保存到数据库
```

### 2. 图片上传方案

**方案A：本地存储（推荐用于小型项目）**
- 优点：简单、免费、完全控制
- 缺点：占用服务器空间、备份困难

**方案B：云存储（推荐用于生产环境）**
- 腾讯云COS / 阿里云OSS / 七牛云
- 优点：CDN加速、自动备份、不占服务器空间
- 缺点：需要付费

### 3. 视频上传方案

**方案A：本地存储（不推荐）**
- 问题：视频文件大、带宽消耗高、无法流式播放

**方案B：云点播服务（强烈推荐）**
- 腾讯云点播 / 阿里云视频点播
- 优点：
  - 自动转码、多码率适配
  - CDN加速、流畅播放
  - 防盗链、加密播放
  - 视频审核功能

**方案C：第三方平台**
- YouTube / Vimeo（需要考虑国内访问）
- 优点：免费、稳定
- 缺点：可能有广告、控制权有限

## 三、具体实施步骤

### 步骤1：扩展图片上传功能

创建文件：`app/api/upload/course-image/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { uploadImage, validateFile, generateFileName } from '@/lib/upload'

export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    
    // 检查管理员权限
    if (!session || session.user.role !== 'ADMIN') {
      return NextResponse.json(
        { error: '需要管理员权限' },
        { status: 403 }
      )
    }

    const formData = await request.formData()
    const file = formData.get('file') as File
    
    if (!file) {
      return NextResponse.json(
        { error: '请选择要上传的图片' },
        { status: 400 }
      )
    }

    // 验证文件
    validateFile({
      size: file.size,
      mimetype: file.type
    }, {
      maxSize: 10 * 1024 * 1024, // 10MB for course images
      allowedTypes: ['image/jpeg', 'image/png', 'image/webp', 'image/gif']
    })

    // 转换为Buffer并上传
    const bytes = await file.arrayBuffer()
    const buffer = Buffer.from(bytes)
    const filename = `course-${Date.now()}-${generateFileName(file.name)}`
    
    const url = await uploadImage(buffer, filename, {
      resize: { width: 1200, height: 800 } // 适合课程内容的尺寸
    })

    return NextResponse.json({
      url,
      filename,
      message: '上传成功'
    })

  } catch (error) {
    console.error('Course image upload error:', error)
    return NextResponse.json(
      { error: '上传失败' },
      { status: 500 }
    )
  }
}
```

### 步骤2：实现视频上传（使用腾讯云点播）

#### 2.1 安装腾讯云SDK
```bash
npm install tencentcloud-sdk-nodejs
```

#### 2.2 创建视频上传配置
创建文件：`lib/video-upload.ts`

```typescript
import * as tencentcloud from "tencentcloud-sdk-nodejs"

const VodClient = tencentcloud.vod.v20180717.Client

// 创建VOD客户端
export function createVodClient() {
  const clientConfig = {
    credential: {
      secretId: process.env.TENCENT_SECRET_ID,
      secretKey: process.env.TENCENT_SECRET_KEY,
    },
    region: "ap-guangzhou", // 根据实际情况选择地域
    profile: {
      httpProfile: {
        endpoint: "vod.tencentcloudapi.com",
      },
    },
  }
  
  return new VodClient(clientConfig)
}

// 获取上传签名
export async function getUploadSignature() {
  const client = createVodClient()
  
  const params = {
    ClassId: 0, // 分类ID，0表示默认分类
    OneTimeValid: 1, // 签名是否单次有效
    SourceContext: JSON.stringify({
      source: "deep-sea-circle",
      uploadTime: new Date().toISOString()
    })
  }
  
  try {
    const response = await client.ApplyUpload(params)
    return {
      signature: response.UploadSignature,
      vodSessionKey: response.VodSessionKey,
      tempCertificate: response.TempCertificate
    }
  } catch (error) {
    console.error('Get upload signature error:', error)
    throw error
  }
}

// 确认上传
export async function confirmUpload(vodSessionKey: string) {
  const client = createVodClient()
  
  const params = {
    VodSessionKey: vodSessionKey
  }
  
  try {
    const response = await client.CommitUpload(params)
    return {
      fileId: response.FileId,
      mediaUrl: response.MediaUrl,
      coverUrl: response.CoverUrl
    }
  } catch (error) {
    console.error('Confirm upload error:', error)
    throw error
  }
}
```

#### 2.3 创建视频上传API
创建文件：`app/api/upload/video/route.ts`

```typescript
import { NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { getUploadSignature } from '@/lib/video-upload'

export async function GET() {
  try {
    const session = await getServerSession(authOptions)
    
    if (!session || session.user.role !== 'ADMIN') {
      return NextResponse.json(
        { error: '需要管理员权限' },
        { status: 403 }
      )
    }

    // 获取腾讯云上传签名
    const uploadInfo = await getUploadSignature()
    
    return NextResponse.json({
      signature: uploadInfo.signature,
      vodSessionKey: uploadInfo.vodSessionKey
    })

  } catch (error) {
    console.error('Get video upload signature error:', error)
    return NextResponse.json(
      { error: '获取上传签名失败' },
      { status: 500 }
    )
  }
}
```

### 步骤3：创建增强的课程内容编辑器

创建文件：`components/course-editor.tsx`

```typescript
'use client'

import { useState, useCallback } from 'react'
import dynamic from 'next/dynamic'
import { Upload, Video, Image, FileText, Loader2 } from 'lucide-react'
import '@uiw/react-md-editor/markdown-editor.css'
import '@uiw/react-markdown-preview/markdown.css'

// 动态导入Markdown编辑器
const MDEditor = dynamic(
  () => import('@uiw/react-md-editor'),
  { ssr: false }
)

interface CourseEditorProps {
  content: string
  onChange: (content: string) => void
  onVideoUpload?: (videoId: string, duration: number) => void
}

export function CourseEditor({ content, onChange, onVideoUpload }: CourseEditorProps) {
  const [uploading, setUploading] = useState(false)
  const [uploadProgress, setUploadProgress] = useState(0)

  // 处理图片上传
  const handleImageUpload = useCallback(async (file: File) => {
    const formData = new FormData()
    formData.append('file', file)

    try {
      setUploading(true)
      const response = await fetch('/api/upload/course-image', {
        method: 'POST',
        body: formData
      })

      if (!response.ok) {
        throw new Error('上传失败')
      }

      const data = await response.json()
      const imageMarkdown = `![${file.name}](${data.url})`
      
      // 在光标位置插入图片
      const newContent = content + '\n' + imageMarkdown + '\n'
      onChange(newContent)
      
    } catch (error) {
      console.error('Image upload error:', error)
      alert('图片上传失败')
    } finally {
      setUploading(false)
    }
  }, [content, onChange])

  // 处理视频上传（使用腾讯云VOD Web SDK）
  const handleVideoUpload = useCallback(async (file: File) => {
    try {
      setUploading(true)
      
      // 1. 获取上传签名
      const signResponse = await fetch('/api/upload/video')
      const { signature, vodSessionKey } = await signResponse.json()
      
      // 2. 使用腾讯云VOD Web SDK上传
      // 注意：需要在页面中引入腾讯云VOD上传SDK
      // <script src="https://cdn-go.cn/cdn/vod-js-sdk-v6/latest/vod-js-sdk-v6.js"></script>
      
      const tcVod = new window.TcVod({
        getSignature: () => signature
      })
      
      const uploader = tcVod.upload({
        mediaFile: file,
      })
      
      uploader.on('media_progress', (info) => {
        setUploadProgress(Math.round(info.percent * 100))
      })
      
      uploader.on('media_upload', (info) => {
        console.log('Video uploaded:', info)
        if (onVideoUpload) {
          onVideoUpload(info.fileId, 0) // duration需要后续获取
        }
      })
      
      await uploader.done()
      
    } catch (error) {
      console.error('Video upload error:', error)
      alert('视频上传失败')
    } finally {
      setUploading(false)
      setUploadProgress(0)
    }
  }, [onVideoUpload])

  // 处理文件拖放
  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault()
    const files = Array.from(e.dataTransfer.files)
    
    files.forEach(file => {
      if (file.type.startsWith('image/')) {
        handleImageUpload(file)
      } else if (file.type.startsWith('video/')) {
        handleVideoUpload(file)
      }
    })
  }, [handleImageUpload, handleVideoUpload])

  return (
    <div className="space-y-4">
      {/* 工具栏 */}
      <div className="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
        <label className="flex items-center gap-2 px-4 py-2 bg-white border rounded-lg cursor-pointer hover:bg-gray-50">
          <Image className="w-5 h-5" />
          <span>上传图片</span>
          <input
            type="file"
            accept="image/*"
            className="hidden"
            onChange={(e) => {
              const file = e.target.files?.[0]
              if (file) handleImageUpload(file)
            }}
            disabled={uploading}
          />
        </label>
        
        <label className="flex items-center gap-2 px-4 py-2 bg-white border rounded-lg cursor-pointer hover:bg-gray-50">
          <Video className="w-5 h-5" />
          <span>上传视频</span>
          <input
            type="file"
            accept="video/*"
            className="hidden"
            onChange={(e) => {
              const file = e.target.files?.[0]
              if (file) handleVideoUpload(file)
            }}
            disabled={uploading}
          />
        </label>
        
        {uploading && (
          <div className="flex items-center gap-2">
            <Loader2 className="w-5 h-5 animate-spin" />
            <span>上传中 {uploadProgress > 0 && `${uploadProgress}%`}</span>
          </div>
        )}
      </div>

      {/* Markdown 编辑器 */}
      <div 
        onDrop={handleDrop}
        onDragOver={(e) => e.preventDefault()}
        className="border-2 border-dashed border-gray-300 rounded-lg p-1 hover:border-gray-400"
      >
        <MDEditor
          value={content}
          onChange={(val) => onChange(val || '')}
          preview="live"
          height={500}
        />
      </div>

      {/* 使用说明 */}
      <div className="text-sm text-gray-600 space-y-1">
        <p>• 支持拖拽上传图片和视频</p>
        <p>• 支持 Markdown 格式：**粗体**、*斜体*、`代码`、[链接](url)</p>
        <p>• 支持代码高亮：使用 ```语言名 开始代码块</p>
      </div>
    </div>
  )
}
```

### 步骤4：更新课程管理界面

更新文件：`app/admin/courses/page.tsx`（在课时编辑部分添加增强编辑器）

```typescript
// 在文件顶部添加导入
import { CourseEditor } from '@/components/course-editor'

// 修改课时内容编辑部分
{lesson.type === 'VIDEO_TEXT' && (
  <div className="space-y-4">
    <div className="grid grid-cols-2 gap-4">
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          视频ID
        </label>
        <input
          type="text"
          value={lesson.videoId || ''}
          onChange={(e) => updateLesson(sectionIndex, lessonIndex, 'videoId', e.target.value)}
          className="w-full px-3 py-2 border rounded"
          placeholder="上传视频后自动填充"
          readOnly
        />
      </div>
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          视频时长（秒）
        </label>
        <input
          type="number"
          value={lesson.duration || ''}
          onChange={(e) => updateLesson(sectionIndex, lessonIndex, 'duration', parseInt(e.target.value))}
          className="w-full px-3 py-2 border rounded"
          placeholder="自动获取"
        />
      </div>
    </div>
  </div>
)}

{/* 使用增强编辑器替换原来的 textarea */}
<CourseEditor
  content={lesson.content}
  onChange={(content) => updateLesson(sectionIndex, lessonIndex, 'content', content)}
  onVideoUpload={(videoId, duration) => {
    updateLesson(sectionIndex, lessonIndex, 'videoId', videoId)
    if (duration > 0) {
      updateLesson(sectionIndex, lessonIndex, 'duration', duration)
    }
  }}
/>
```

### 步骤5：创建课程内容展示页面

更新文件：`app/courses/[sectionSlug]/[courseSlug]/page.tsx`

```typescript
import ReactMarkdown from 'react-markdown'
import remarkGfm from 'remark-gfm'
import rehypeHighlight from 'rehype-highlight'
import 'highlight.js/styles/github.css'

// 视频播放器组件
function VideoPlayer({ videoId }: { videoId: string }) {
  return (
    <div className="relative aspect-video bg-black rounded-lg overflow-hidden mb-6">
      {/* 使用腾讯云播放器 */}
      <video
        id={`video-${videoId}`}
        className="w-full h-full"
        controls
        preload="metadata"
      >
        {/* 视频URL需要从腾讯云获取 */}
      </video>
    </div>
  )
}

// 课程内容展示组件
function LessonContent({ lesson }: { lesson: any }) {
  return (
    <div className="max-w-4xl mx-auto">
      {/* 视频播放器 */}
      {lesson.type === 'VIDEO_TEXT' && lesson.videoId && (
        <VideoPlayer videoId={lesson.videoId} />
      )}
      
      {/* 文字内容 */}
      <div className="prose prose-lg max-w-none">
        <ReactMarkdown
          remarkPlugins={[remarkGfm]}
          rehypePlugins={[rehypeHighlight]}
          components={{
            // 自定义图片渲染
            img: ({ src, alt }) => (
              <img
                src={src}
                alt={alt}
                className="rounded-lg shadow-md my-4"
                loading="lazy"
              />
            ),
            // 自定义代码块
            code: ({ inline, className, children, ...props }) => {
              const match = /language-(\w+)/.exec(className || '')
              return !inline && match ? (
                <div className="relative group">
                  <div className="absolute top-0 right-0 px-2 py-1 text-xs text-gray-500 bg-gray-100 rounded-bl">
                    {match[1]}
                  </div>
                  <pre className={className}>
                    <code {...props}>{children}</code>
                  </pre>
                </div>
              ) : (
                <code className="px-1 py-0.5 bg-gray-100 rounded text-sm" {...props}>
                  {children}
                </code>
              )
            }
          }}
        >
          {lesson.content}
        </ReactMarkdown>
      </div>
    </div>
  )
}
```

## 四、环境配置

### 1. 更新 .env.local
```env
# 腾讯云配置（如果使用视频上传）
TENCENT_SECRET_ID=your-secret-id
TENCENT_SECRET_KEY=your-secret-key
TENCENT_VOD_APP_ID=your-app-id

# 文件上传限制
MAX_IMAGE_SIZE=10485760  # 10MB
MAX_VIDEO_SIZE=524288000 # 500MB
```

### 2. 更新 next.config.ts
```typescript
const nextConfig: NextConfig = {
  images: {
    domains: ['localhost', 'your-domain.com'],
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**',
      },
    ],
  },
  // 增加请求体大小限制
  api: {
    bodyParser: {
      sizeLimit: '100mb',
    },
  },
}
```

## 五、使用流程

### 管理员上传课程内容：

1. **登录管理后台**
   - 访问 `/admin/courses`
   - 使用管理员账号登录

2. **创建课程结构**
   - 添加章节（如：基础篇、认知篇）
   - 在每个章节下添加课时

3. **上传课程内容**
   - **文字**：直接在编辑器中输入或粘贴
   - **图片**：点击上传按钮或拖拽到编辑器
   - **视频**：点击上传按钮选择视频文件

4. **保存发布**
   - 点击保存按钮
   - 设置是否免费试看

### 用户访问课程：

1. 访问 `/courses` 查看课程列表
2. 选择章节和课时
3. 观看视频和阅读文字内容
4. 记录学习进度

## 六、进阶优化

### 1. 视频处理优化
- 自动生成多种清晰度
- 添加水印保护
- 实现HLS流媒体播放
- 添加字幕支持

### 2. 图片处理优化
- 自动压缩优化
- 生成不同尺寸缩略图
- 懒加载优化
- WebP格式支持

### 3. 内容保护
- 视频防下载
- 图片防盗链
- 内容加密
- 访问权限控制

### 4. 用户体验优化
- 断点续传
- 离线缓存
- 学习笔记
- 进度同步

## 七、成本估算

### 本地存储方案：
- 服务器存储空间：约 ¥50-200/月
- CDN流量费用：约 ¥0.15-0.25/GB

### 云存储方案（腾讯云）：
- 对象存储：约 ¥0.099/GB/月
- CDN流量：约 ¥0.15/GB
- 视频点播：约 ¥0.028/GB存储 + ¥0.15/GB流量
- 视频转码：约 ¥0.065/分钟

### 建议：
- 小型项目（<100GB）：使用本地存储
- 中大型项目：使用云存储服务
- 视频内容多：必须使用专业视频云服务

## 八、安全建议

1. **访问控制**
   - 实施严格的权限验证
   - 使用防盗链技术
   - 限制下载功能

2. **内容审核**
   - 图片鉴黄
   - 视频审核
   - 敏感词过滤

3. **数据备份**
   - 定期备份数据库
   - 文件增量备份
   - 异地容灾

4. **性能优化**
   - 使用CDN加速
   - 图片懒加载
   - 视频预加载策略

## 九、故障处理

### 常见问题：

1. **上传失败**
   - 检查文件大小限制
   - 验证文件格式
   - 查看服务器日志

2. **视频无法播放**
   - 检查视频编码格式
   - 验证CDN配置
   - 查看浏览器兼容性

3. **图片加载慢**
   - 启用图片压缩
   - 配置CDN
   - 实施懒加载

## 十、总结

这个方案提供了完整的课程内容上传和管理功能：

1. ✅ 支持文字、图片、视频三种格式
2. ✅ 提供了本地和云存储两种方案
3. ✅ 包含完整的管理界面和展示页面
4. ✅ 考虑了安全性和性能优化
5. ✅ 提供了详细的实施步骤和代码示例

根据您的实际需求和预算，可以选择合适的存储方案开始实施。建议先从本地存储开始，随着用户增长再迁移到云服务。