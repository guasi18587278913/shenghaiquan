# 深海圈网站部署命令列表

本文档包含所有需要执行的命令，可以直接复制粘贴到终端执行。

## 一、修复 PostgreSQL（当前步骤）

### 选项A：继续修复 PostgreSQL

```bash
# 1. 停止 PostgreSQL
systemctl stop postgresql

# 2. 重新创建配置文件
cat > /var/lib/pgsql/data/pg_hba.conf << 'EOF'
# TYPE  DATABASE        USER            ADDRESS                 METHOD
local   all             all                                     trust
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
local   replication     all                                     trust
host    replication     all             127.0.0.1/32            md5
host    replication     all             ::1/128                 md5
EOF

# 3. 设置权限
chown -R postgres:postgres /var/lib/pgsql/data
chmod 700 /var/lib/pgsql/data

# 4. 启动 PostgreSQL
systemctl start postgresql
systemctl status postgresql

# 5. 如果成功，创建数据库
sudo -u postgres psql << 'EOF'
CREATE DATABASE deepseacircle;
CREATE USER deepseauser WITH PASSWORD 'DeepSea@2024';
GRANT ALL PRIVILEGES ON DATABASE deepseacircle TO deepseauser;
\q
EOF
```

### 选项B：改用 MySQL（更简单）

```bash
# 1. 安装 MySQL
yum install -y mysql mysql-server

# 2. 启动 MySQL
systemctl start mysqld
systemctl enable mysqld

# 3. 获取初始密码
grep 'temporary password' /var/log/mysqld.log

# 4. 安全配置（会提示输入新密码）
mysql_secure_installation

# 5. 创建数据库
mysql -u root -p << 'EOF'
CREATE DATABASE deepseacircle CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'deepseauser'@'localhost' IDENTIFIED BY 'DeepSea@2024';
GRANT ALL PRIVILEGES ON deepseacircle.* TO 'deepseauser'@'localhost';
FLUSH PRIVILEGES;
EXIT;
EOF
```

## 二、继续安装其他软件

```bash
# 1. 安装 Git
yum install -y git

# 2. 安装 PM2
npm install -g pm2

# 3. 验证安装
pm2 --version
git --version
nginx -v
```

## 三、克隆项目

```bash
# 1. 创建目录
mkdir -p /var/www
cd /var/www

# 2. 克隆项目
git clone https://github.com/guasi18587278913/shenghaiquan.git deepseacircle

# 3. 设置权限
chown -R root:root /var/www/deepseacircle
```

## 四、部署 Strapi

```bash
# 1. 进入 Strapi 目录
cd /var/www/deepseacircle/deepsea-cms

# 2. 安装依赖
npm install

# 3. 创建生产环境配置（PostgreSQL 版本）
cat > .env.production << 'EOF'
NODE_ENV=production
HOST=0.0.0.0
PORT=1337
APP_KEYS=base64key1,base64key2,base64key3,base64key4
API_TOKEN_SALT=randomsalt123
ADMIN_JWT_SECRET=adminjwtsecret456
JWT_SECRET=jwtsecret789
DATABASE_CLIENT=postgres
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=deepseacircle
DATABASE_USERNAME=deepseauser
DATABASE_PASSWORD=DeepSea@2024
EOF

# 3. 创建生产环境配置（MySQL 版本）
cat > .env.production << 'EOF'
NODE_ENV=production
HOST=0.0.0.0
PORT=1337
APP_KEYS=base64key1,base64key2,base64key3,base64key4
API_TOKEN_SALT=randomsalt123
ADMIN_JWT_SECRET=adminjwtsecret456
JWT_SECRET=jwtsecret789
DATABASE_CLIENT=mysql
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_NAME=deepseacircle
DATABASE_USERNAME=deepseauser
DATABASE_PASSWORD=DeepSea@2024
EOF

# 4. 生成随机密钥（执行4次，替换上面的密钥）
node -e "console.log(require('crypto').randomBytes(16).toString('base64'))"

# 5. 构建 Strapi
NODE_ENV=production npm run build

# 6. 创建 PM2 配置
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'strapi-cms',
    script: 'npm',
    args: 'start',
    cwd: '/var/www/deepseacircle/deepsea-cms',
    env: {
      NODE_ENV: 'production'
    }
  }]
};
EOF

# 7. 启动 Strapi
pm2 start ecosystem.config.js
pm2 status
pm2 logs strapi-cms --lines 20
```

## 五、部署 Next.js

```bash
# 1. 进入项目根目录
cd /var/www/deepseacircle

# 2. 安装依赖
npm install

# 3. 创建环境配置
cat > .env.production.local << 'EOF'
NEXT_PUBLIC_STRAPI_URL=http://111.231.19.162:1337
NEXT_PUBLIC_SITE_URL=http://111.231.19.162
DATABASE_URL=postgresql://deepseauser:DeepSea@2024@localhost:5432/deepseacircle
NEXTAUTH_URL=http://111.231.19.162
NEXTAUTH_SECRET=your-nextauth-secret-key-2024
EOF

# 4. 构建项目
npm run build

# 5. 创建 PM2 配置
cat > ecosystem.nextjs.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'nextjs-app',
    script: 'npm',
    args: 'start',
    cwd: '/var/www/deepseacircle',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
};
EOF

# 6. 启动 Next.js
pm2 start ecosystem.nextjs.config.js
pm2 status
```

## 六、配置 Nginx

```bash
# 1. 创建 Nginx 配置
cat > /etc/nginx/conf.d/deepseacircle.conf << 'EOF'
server {
    listen 80;
    server_name 111.231.19.162;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    location /admin {
        proxy_pass http://localhost:1337/admin;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location /api {
        proxy_pass http://localhost:1337/api;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;
    }

    location /uploads {
        proxy_pass http://localhost:1337/uploads;
    }

    client_max_body_size 100M;
}
EOF

# 2. 测试 Nginx 配置
nginx -t

# 3. 重启 Nginx
systemctl restart nginx

# 4. 设置 PM2 开机自启
pm2 save
pm2 startup
```

## 七、数据迁移（在本地执行）

```bash
# 1. 导出本地 Strapi 数据（在本地 Mac 执行）
cd /Users/liyadong/Documents/GitHub/深海圈网站/deepsea-cms
pg_dump -h localhost -U postgres deepseacircle > strapi_backup.sql
tar -czf uploads.tar.gz public/uploads

# 2. 上传到服务器（在本地 Mac 执行）
scp strapi_backup.sql root@111.231.19.162:/tmp/
scp uploads.tar.gz root@111.231.19.162:/tmp/

# 3. 导入数据（在服务器执行）
cd /tmp
sudo -u postgres psql deepseacircle < strapi_backup.sql
cd /var/www/deepseacircle/deepsea-cms
tar -xzf /tmp/uploads.tar.gz
chown -R root:root public/uploads
pm2 restart all
```

## 八、测试命令

```bash
# 1. 查看所有服务状态
pm2 status

# 2. 查看日志
pm2 logs

# 3. 测试网站
curl http://localhost:3000
curl http://localhost:1337/api

# 4. 查看端口占用
netstat -tlnp | grep -E '3000|1337|80'
```

## 九、常用维护命令

```bash
# 重启所有服务
pm2 restart all

# 查看日志
pm2 logs nextjs-app
pm2 logs strapi-cms

# 更新代码
cd /var/www/deepseacircle
git pull
npm install
npm run build
pm2 restart all
```