# 统一权限管理方案（无需双重密码）

## 最佳实践：WordPress 公开 + Next.js 控制访问

### 1. WordPress 设置
- **所有文章设为"公开"** - 方便管理
- 但是 WordPress 网站本身不对外开放
- 只作为内容存储和管理后台

### 2. Next.js 端控制权限

```typescript
// app/courses/wp/[slug]/page.tsx 添加权限检查
import { useSession } from 'next-auth/react';
import { redirect } from 'next/navigation';

export default function CourseDetailPage() {
  const { data: session, status } = useSession();
  
  // 检查登录状态
  if (status === 'loading') return <Loading />;
  if (!session) {
    redirect('/login?callbackUrl=/courses/wp/' + params.slug);
  }
  
  // 检查是否付费用户
  if (!session.user.isPaid) {
    return <UpgradePrompt />;
  }
  
  // 正常显示课程内容
  return <CourseContent />;
}
```

### 3. API 层面保护

```typescript
// lib/wordpress-api.ts 修改
export async function getPost(idOrSlug: string | number, userToken?: string): Promise<WPPost> {
  // 验证用户权限
  if (!userToken || !await verifyUserAccess(userToken)) {
    throw new Error('Unauthorized');
  }
  
  // 获取内容
  const response = await fetch(`${WP_API_URL}/posts/${idOrSlug}`);
  return response.json();
}
```

## 技术保护措施（不影响体验）

### 1. 防止直接访问 WordPress
在服务器上限制 WordPress 访问：

```nginx
# Nginx 配置
location /wp-json/ {
    # 只允许你的 Next.js 服务器访问
    allow 127.0.0.1;
    allow 你的Next.js服务器IP;
    deny all;
}

# 禁止直接访问 WordPress 前台
location / {
    if ($host = "111.231.19.162") {
        return 301 https://deepseacircle.com$request_uri;
    }
}
```

### 2. 内容保护（前端）

```typescript
// components/ProtectedContent.tsx
export function ProtectedContent({ children }) {
  useEffect(() => {
    // 禁用右键
    const handleContextMenu = (e) => e.preventDefault();
    document.addEventListener('contextmenu', handleContextMenu);
    
    // 禁用文本选择
    document.body.style.userSelect = 'none';
    
    // 禁用打印
    const style = document.createElement('style');
    style.innerHTML = '@media print { body { display: none; } }';
    document.head.appendChild(style);
    
    return () => {
      document.removeEventListener('contextmenu', handleContextMenu);
      document.body.style.userSelect = 'auto';
      style.remove();
    };
  }, []);
  
  return <div className="protected-content">{children}</div>;
}
```

### 3. 图片防盗链
使用腾讯云 COS 的防盗链功能：
- 设置允许的域名
- 使用签名 URL
- 设置过期时间

### 4. 视频保护
使用腾讯云点播的 DRM 加密：
- HLS 加密
- 防录屏水印
- 动态 URL

## 用户体验优化

### 1. 单点登录
```typescript
// 用户只需登录一次
- Next.js 登录 ✓
- 自动获取 WordPress 内容 ✓
- 无需额外密码 ✓
```

### 2. 分级内容展示
```typescript
// 根据用户等级显示不同内容
const CourseList = () => {
  const { user } = useSession();
  
  return (
    <>
      {/* 免费预览 */}
      <FreePreview />
      
      {/* 付费内容 */}
      {user?.isPaid ? (
        <PremiumContent />
      ) : (
        <UpgradePrompt />
      )}
    </>
  );
};
```

### 3. 智能提醒
```typescript
// 友好的权限提示
const AccessDenied = () => (
  <div className="text-center py-20">
    <h2>升级会员解锁全部课程</h2>
    <p>您正在查看的是付费内容</p>
    <Button onClick={upgrade}>立即升级</Button>
    <Link href="/free-courses">查看免费课程</Link>
  </div>
);
```

## 推荐架构

```
用户 → Next.js (权限控制) → WordPress API (内部) → 内容
         ↓
      登录/支付
```

这样：
1. ✅ 用户体验好（只需登录一次）
2. ✅ 内容安全（API 层保护）
3. ✅ 管理方便（WordPress 后台）
4. ✅ 灵活控制（Next.js 权限系统）

## 实施步骤

1. WordPress 保持"公开"设置
2. 限制 WordPress 直接访问
3. Next.js 实现登录系统
4. API 调用时验证权限
5. 前端添加防复制措施

这样既保护了版权，又不影响付费用户的体验！