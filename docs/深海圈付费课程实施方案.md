# 深海圈付费课程实施方案

## 一、核心理念

深海圈是一个**年度付费会员制**的高端学习社区，我们需要：
1. **保护内容价值**：防止盗版传播
2. **优化学习体验**：不能因为保护而影响体验
3. **建立信任关系**：合理保护，不过度防范

## 二、内容分级策略

### 1. 免费预览内容（引流）
```
可公开访问：
├── 课程大纲结构
├── 前言章节（3-5节）
├── 每章第一节预览
├── 部分社区讨论
└── 学员成功案例
```

### 2. 付费会员内容（核心）
```
年度会员专享：
├── 完整视频课程
├── 详细图文教程
├── 源码下载
├── 直播回放
├── 社区完整权限
└── 1对1答疑机会
```

## 三、视频保护方案

### 使用腾讯云点播（推荐）

#### 1. 技术架构
```
视频上传 → 转码加密 → KEY防盗链 → 播放鉴权 → 客户端解密
```

#### 2. 实现步骤

```typescript
// 1. 后端：生成播放凭证
// app/api/video/play-auth/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import TencentCloud from 'tencentcloud-sdk-nodejs'

export async function POST(request: NextRequest) {
  const session = await getServerSession()
  
  // 验证会员身份
  if (!session || session.user.membershipType !== 'annual') {
    return NextResponse.json({ error: '无权限' }, { status: 403 })
  }
  
  const { videoId } = await request.json()
  
  // 生成防盗链签名
  const currentTime = Math.floor(Date.now() / 1000)
  const psign = generatePsign({
    appId: process.env.VOD_APP_ID,
    fileId: videoId,
    currentTimeStamp: currentTime,
    expireTimeStamp: currentTime + 3600, // 1小时有效
    urlAccessInfo: {
      t: currentTime + 3600,
      us: session.user.id, // 用户标识
      rlimit: 3, // 限制访问次数
      w: 1 // 启用防盗链
    }
  })
  
  return NextResponse.json({
    appId: process.env.VOD_APP_ID,
    fileId: videoId,
    psign
  })
}
```

```typescript
// 2. 前端：安全播放器组件
// app/components/SecureVideoPlayer.tsx
'use client'

import { useEffect, useRef, useState } from 'react'
import { useSession } from 'next-auth/react'

export function SecureVideoPlayer({ 
  videoId, 
  title,
  onProgress 
}: {
  videoId: string
  title: string
  onProgress?: (progress: number) => void
}) {
  const { data: session } = useSession()
  const playerRef = useRef(null)
  const [isLoading, setIsLoading] = useState(true)
  
  useEffect(() => {
    if (!session) return
    
    let player: any
    
    const initPlayer = async () => {
      // 获取播放凭证
      const res = await fetch('/api/video/play-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ videoId })
      })
      
      if (!res.ok) {
        alert('无权播放此视频')
        return
      }
      
      const { appId, fileId, psign } = await res.json()
      
      // 动态加载腾讯云播放器
      const script = document.createElement('script')
      script.src = 'https://web.sdk.qcloud.com/player/tcplayer/release/v4.6.0/tcplayer.v4.6.0.min.js'
      script.onload = () => {
        player = TCPlayer('player-container', {
          fileID: fileId,
          appID: appId,
          psign: psign,
          
          // 播放器配置
          controls: true,
          playbackRates: [0.5, 1, 1.25, 1.5, 2],
          
          // 水印配置
          plugins: {
            ContinuePlay: {}, // 续播
            ProgressMarker: {}, // 进度标记
            
            // 动态水印
            DynamicWatermark: {
              content: () => {
                const now = new Date().toLocaleString('zh-CN')
                return `${session.user.id.slice(-6)} ${now}`
              },
              className: 'custom-watermark',
              changeDuration: 10000 // 10秒更新
            },
            
            // 防录屏
            ScreenshotPrevention: {
              message: '检测到录屏行为，视频已暂停'
            }
          }
        })
        
        // 监听事件
        player.on('loadedmetadata', () => {
          setIsLoading(false)
        })
        
        player.on('timeupdate', () => {
          const progress = (player.currentTime() / player.duration()) * 100
          onProgress?.(progress)
          
          // 每30秒记录一次进度
          if (Math.floor(player.currentTime()) % 30 === 0) {
            fetch('/api/video/progress', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                videoId,
                progress: player.currentTime(),
                duration: player.duration()
              })
            })
          }
        })
        
        // 防止多开
        player.on('error', (e: any) => {
          if (e.type === 'PLAY_DUPLICATE') {
            alert('检测到多设备同时播放，请关闭其他设备')
          }
        })
      }
      
      document.head.appendChild(script)
    }
    
    initPlayer()
    
    return () => {
      player?.dispose()
    }
  }, [videoId, session])
  
  return (
    <div className="video-player-wrapper">
      {isLoading && (
        <div className="loading-spinner">
          加载中...
        </div>
      )}
      
      <div 
        id="player-container" 
        style={{ width: '100%', height: '100%' }}
      />
      
      <style jsx>{`
        .video-player-wrapper {
          position: relative;
          width: 100%;
          padding-bottom: 56.25%; /* 16:9 */
          background: #000;
        }
        
        #player-container {
          position: absolute;
          top: 0;
          left: 0;
        }
        
        :global(.custom-watermark) {
          color: rgba(255, 255, 255, 0.3);
          font-size: 14px;
          pointer-events: none;
        }
      `}</style>
    </div>
  )
}
```

## 四、文本内容保护

### 1. 分级保护策略

```typescript
// app/components/SecureMarkdown.tsx
import { ContentProtection } from './content-protection'
import { MarkdownViewer } from './markdown-viewer'

export function SecureMarkdown({ 
  content, 
  level = 'medium' 
}: {
  content: string
  level?: 'low' | 'medium' | 'high'
}) {
  // 代码块特殊处理 - 允许复制
  const processContent = (markdown: string) => {
    // 提取代码块
    const codeBlocks: string[] = []
    const processedContent = markdown.replace(
      /```[\s\S]*?```/g,
      (match) => {
        codeBlocks.push(match)
        return `__CODE_BLOCK_${codeBlocks.length - 1}__`
      }
    )
    
    return { processedContent, codeBlocks }
  }
  
  const { processedContent, codeBlocks } = processContent(content)
  
  return (
    <div className="secure-markdown">
      {/* 普通内容 - 保护 */}
      <ContentProtection level={level}>
        <MarkdownViewer 
          content={processedContent}
          components={{
            // 自定义代码块渲染
            code: ({ children, className }) => {
              const match = children?.toString().match(/__CODE_BLOCK_(\d+)__/)
              if (match) {
                const codeBlock = codeBlocks[parseInt(match[1])]
                return (
                  <div className="code-block-wrapper">
                    <pre className={className}>
                      <code>{codeBlock}</code>
                    </pre>
                    <button 
                      className="copy-button"
                      onClick={() => navigator.clipboard.writeText(codeBlock)}
                    >
                      复制代码
                    </button>
                  </div>
                )
              }
              return <code className={className}>{children}</code>
            }
          }}
        />
      </ContentProtection>
    </div>
  )
}
```

### 2. 增强保护组件

```typescript
// app/components/EnhancedContentProtection.tsx
'use client'

import { useEffect, useRef } from 'react'
import { useSession } from 'next-auth/react'
import { ContentProtection } from './content-protection'
import { Watermark } from './watermark'

export function EnhancedContentProtection({ 
  children,
  level = 'medium' 
}: {
  children: React.ReactNode
  level?: 'low' | 'medium' | 'high'
}) {
  const { data: session } = useSession()
  const contentRef = useRef<HTMLDivElement>(null)
  
  useEffect(() => {
    if (level === 'high' && contentRef.current) {
      // 监听截图行为（仅作提醒）
      let lastActivity = Date.now()
      
      const detectScreenshot = () => {
        const now = Date.now()
        const timeDiff = now - lastActivity
        
        // 如果页面失焦超过100ms可能是截图
        if (timeDiff > 100 && document.hidden) {
          console.log('可能的截图行为')
          // 记录但不阻止
          fetch('/api/security/log', {
            method: 'POST',
            body: JSON.stringify({
              action: 'possible_screenshot',
              userId: session?.user?.id
            })
          })
        }
        
        lastActivity = now
      }
      
      document.addEventListener('visibilitychange', detectScreenshot)
      window.addEventListener('blur', detectScreenshot)
      
      return () => {
        document.removeEventListener('visibilitychange', detectScreenshot)
        window.removeEventListener('blur', detectScreenshot)
      }
    }
  }, [level, session])
  
  return (
    <div ref={contentRef} className="enhanced-protection">
      <ContentProtection 
        disableSelect={level !== 'low'}
        disableCopy={level !== 'low'}
        disableRightClick={level === 'high'}
        disablePrint={true}
      >
        {children}
      </ContentProtection>
      
      {/* 水印层 */}
      {level !== 'low' && session && (
        <Watermark 
          text={`${session.user.id.slice(-6)}`}
          opacity={level === 'high' ? 0.15 : 0.08}
        />
      )}
    </div>
  )
}
```

## 五、实施计划

### 第一阶段：基础版本（1周）
1. **集成腾讯云点播**
   - [ ] 申请腾讯云账号
   - [ ] 配置点播服务
   - [ ] 实现上传接口
   - [ ] 基础播放器

2. **文本基础保护**
   - [ ] 禁用复制功能
   - [ ] 添加静态水印
   - [ ] 基础防护措施

### 第二阶段：增强保护（2周）
1. **视频高级功能**
   - [ ] HLS加密
   - [ ] 动态水印
   - [ ] 防盗链
   - [ ] 播放鉴权

2. **文本高级保护**
   - [ ] 动态水印
   - [ ] 行为监控
   - [ ] 代码块处理

### 第三阶段：体验优化（1周）
1. **性能优化**
   - [ ] 缓存策略
   - [ ] 加载优化
   - [ ] 移动端适配

2. **用户体验**
   - [ ] 记忆播放位置
   - [ ] 笔记功能
   - [ ] 快捷键支持

## 六、成本分析

### 腾讯云点播定价（2024年标准）
- 存储：0.0048元/GB/天
- 普通转码：0.016元/分钟
- 加密转码：0.0192元/分钟（+20%）
- CDN流量：0.15元/GB

### 预估成本（1000会员）
- 课程总时长：100小时
- 平均每人每月观看：10小时
- 月流量：1000人 × 10小时 × 0.5GB/小时 = 5TB

**月度成本**：
- 存储：100GB × 0.0048 × 30 = 14.4元
- 流量：5000GB × 0.15 = 750元
- 总计：约800元/月

## 七、注意事项

1. **平衡保护与体验**
   - 不要过度保护影响正常学习
   - 代码示例必须可复制
   - 提供离线文档下载（加水印）

2. **法律合规**
   - 用户协议明确版权条款
   - 记录侵权证据
   - 保留法律追诉权

3. **技术迭代**
   - 根据用户反馈调整
   - 监控绕过行为
   - 持续优化方案