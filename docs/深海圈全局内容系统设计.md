# 深海圈全局内容系统设计

## 一、项目全局定位

### 核心价值
深海圈是一个**高价值付费社区**，提供：
1. **系统化课程**：从基础到进阶的完整学习路径
2. **实时社区**：905名付费会员的互动交流
3. **持续更新**：直播答疑、案例分享、最新趋势

### 用户分层
- **游客**：可以查看课程大纲、社区动态预览
- **年度会员**：完整课程访问权、社区互动、直播参与

## 二、内容呈现与保护整体方案

### 1. 分级内容策略

```
内容级别划分
├── 公开内容（吸引用户）
│   ├── 课程大纲
│   ├── 前言章节
│   ├── 部分社区讨论
│   └── 成功案例展示
│
├── 会员专享内容（核心价值）
│   ├── 完整课程视频
│   ├── 详细图文教程
│   ├── 代码示例下载
│   ├── 直播回放
│   └── 会员专属讨论
│
└── 高级内容（增值服务）
    ├── 1对1答疑
    ├── 项目诊断
    └── 商业资源对接
```

### 2. 技术保护方案

#### A. 视频保护
```javascript
// 使用腾讯云点播加密方案
视频保护措施：
1. HLS加密传输
2. 防盗链设置
3. 动态水印（用户ID）
4. 禁止下载
5. 防录屏检测
6. 限制并发播放
```

#### B. 文本保护
```javascript
// 多层防护
文本保护措施：
1. 禁用右键菜单
2. 禁止文本选择
3. 禁用开发者工具
4. 内容加密传输
5. 动态水印覆盖
6. 截图检测警告
```

### 3. 用户体验平衡

```
保护强度分级：
├── 低价值内容 → 轻度保护（保证体验）
├── 中价值内容 → 中度保护（平衡体验）
└── 高价值内容 → 重度保护（优先安全）
```

## 三、具体实现方案

### 1. 视频系统架构

```
腾讯云点播方案：
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│   视频上传   │ --> │  转码+加密    │ --> │  CDN分发    │
└─────────────┘     └──────────────┘     └─────────────┘
                            ↓
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│  播放鉴权   │ <-- │  防盗链验证   │ <-- │  用户请求    │
└─────────────┘     └──────────────┘     └─────────────┘
```

#### 实现代码示例

```typescript
// app/components/SecureVideoPlayer.tsx
import { useEffect, useRef } from 'react'
import TCPlayer from 'tcplayer.js'

export function SecureVideoPlayer({ videoId, userId }) {
  const playerRef = useRef(null)
  
  useEffect(() => {
    // 获取播放凭证
    const getPlayAuth = async () => {
      const res = await fetch('/api/video/auth', {
        method: 'POST',
        body: JSON.stringify({ videoId, userId })
      })
      return res.json()
    }
    
    // 初始化播放器
    const initPlayer = async () => {
      const { playAuth, appId } = await getPlayAuth()
      
      const player = TCPlayer('player-container', {
        fileID: videoId,
        appID: appId,
        psign: playAuth,
        // 防录屏水印
        watermark: {
          text: `${userId}`,
          opacity: 0.3,
          position: 'random' // 随机位置
        },
        // 禁用右键
        contextmenu: false,
        // 防盗链
        plugins: {
          ContinuePlay: {},
          ProgressMarker: {},
          DynamicWatermark: {
            text: userId,
            interval: 5000 // 5秒变换位置
          }
        }
      })
      
      // 监听异常
      player.on('error', (e) => {
        if (e.code === 'PLAY_DETECT_MULTIPLE') {
          alert('检测到多设备同时播放')
        }
      })
    }
    
    initPlayer()
  }, [videoId, userId])
  
  return <div id="player-container" />
}
```

### 2. 文本保护实现

```typescript
// app/components/SecureContent.tsx
'use client'

import { useEffect } from 'react'
import { useSession } from 'next-auth/react'

export function SecureContent({ children, level = 'medium' }) {
  const { data: session } = useSession()
  
  useEffect(() => {
    if (level === 'high') {
      // 禁用右键
      document.addEventListener('contextmenu', (e) => e.preventDefault())
      
      // 禁用文本选择
      document.addEventListener('selectstart', (e) => e.preventDefault())
      
      // 禁用复制
      document.addEventListener('copy', (e) => e.preventDefault())
      
      // 检测开发者工具
      const devtools = { open: false, orientation: null }
      setInterval(() => {
        if (window.outerHeight - window.innerHeight > 200) {
          if (!devtools.open) {
            alert('请关闭开发者工具')
            // 记录行为
            fetch('/api/security/log', {
              method: 'POST',
              body: JSON.stringify({
                userId: session?.user?.id,
                action: 'devtools_open'
              })
            })
          }
          devtools.open = true
        }
      }, 500)
    }
    
    // 添加水印
    if (level !== 'low') {
      const watermark = document.createElement('div')
      watermark.className = 'watermark'
      watermark.innerHTML = `
        <div class="watermark-text">
          ${session?.user?.id || 'GUEST'}
        </div>
      `
      document.body.appendChild(watermark)
    }
  }, [level, session])
  
  return (
    <div className="secure-content" data-level={level}>
      {children}
    </div>
  )
}
```

### 3. 系统集成方案

```typescript
// 课程学习页面整合
export default function LessonPage({ lesson }) {
  const { data: session } = useSession()
  
  // 检查权限
  if (!session || session.user.membershipType !== 'annual') {
    return <UpgradePrompt />
  }
  
  return (
    <div className="lesson-page">
      {/* 视频内容 */}
      {lesson.videoId && (
        <SecureVideoPlayer 
          videoId={lesson.videoId}
          userId={session.user.id}
        />
      )}
      
      {/* 文本内容 */}
      <SecureContent level={lesson.securityLevel}>
        <MarkdownViewer content={lesson.content} />
      </SecureContent>
      
      {/* 代码示例（可复制） */}
      <div className="code-examples">
        <CodeBlock 
          code={lesson.codeExamples}
          allowCopy={true} // 代码允许复制
        />
      </div>
    </div>
  )
}
```

## 四、内容管理后台

### 1. 上传流程

```
内容上传工作流：
1. 视频上传 → 自动转码 → 加密处理 → 生成播放凭证
2. 文档上传 → Markdown解析 → 敏感词检测 → 分级保护
3. 资源关联 → 课程绑定 → 权限设置 → 发布审核
```

### 2. 管理界面设计

```typescript
// app/admin/courses/upload/page.tsx
export default function CourseUploadPage() {
  return (
    <div className="upload-page">
      <Tabs>
        <TabsContent value="video">
          <VideoUploader 
            onUpload={handleVideoUpload}
            encryption={true}
            watermark={true}
          />
        </TabsContent>
        
        <TabsContent value="document">
          <MarkdownEditor
            onSave={handleDocumentSave}
            securityLevel="high"
          />
        </TabsContent>
        
        <TabsContent value="resources">
          <ResourceManager />
        </TabsContent>
      </Tabs>
    </div>
  )
}
```

## 五、监控与分析

### 1. 安全监控

```javascript
// 监控指标
const securityMetrics = {
  // 异常行为
  multipleDeviceLogin: 0,
  devtoolsOpen: 0,
  screenshotAttempts: 0,
  
  // 内容访问
  videoViews: 0,
  documentReads: 0,
  resourceDownloads: 0,
  
  // 用户行为
  averageWatchTime: 0,
  completionRate: 0,
  repeatViews: 0
}
```

### 2. 用户体验优化

```javascript
// 根据用户反馈动态调整
const adaptiveProtection = {
  // 可信用户降低保护
  trustedUsers: {
    watermarkOpacity: 0.1,
    devtoolsCheck: false
  },
  
  // 风险用户加强保护  
  riskyUsers: {
    watermarkOpacity: 0.5,
    concurrentLimit: 1,
    downloadDisabled: true
  }
}
```

## 六、实施步骤

### Phase 1：基础保护（1周）
- [ ] 集成腾讯云点播
- [ ] 实现基础防复制
- [ ] 添加用户水印

### Phase 2：高级保护（2周）
- [ ] HLS加密播放
- [ ] 防录屏检测
- [ ] 动态水印

### Phase 3：体验优化（1周）
- [ ] 自适应保护
- [ ] 性能优化
- [ ] 移动端适配

## 七、成本预算

### 腾讯云点播费用（预估）
- 存储：0.0048元/GB/天
- 转码：0.065元/分钟（高清）
- 流量：0.15元/GB
- 加密：额外20%费用

### 月度成本（1000用户）
- 视频存储：500GB × 0.0048 × 30 = 72元
- 转码费用：100小时 × 60 × 0.065 = 390元
- 流量费用：2TB × 0.15 × 1024 = 307元
- 总计：约800-1000元/月