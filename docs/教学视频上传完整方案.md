# 深海圈教学视频上传完整方案

## 📋 方案概述

本方案提供三种视频上传方式，按推荐程度排序：
1. **腾讯云点播（推荐）** - 专业视频解决方案
2. **腾讯云COS存储** - 简单直接
3. **本地存储** - 开发测试使用

## 🚀 方案一：腾讯云点播（VOD）【推荐】

### 优势
- ✅ 自动转码，支持多种清晰度
- ✅ 防盗链保护
- ✅ 流畅播放，CDN加速
- ✅ 支持大文件上传（最大48.82GB）
- ✅ 自动生成视频封面

### 配置步骤

#### 1. 开通腾讯云点播服务
```bash
1. 登录腾讯云控制台
2. 搜索"云点播VOD"
3. 开通服务（新用户有免费额度）
4. 获取SecretId和SecretKey
```

#### 2. 配置环境变量
在 `.env.local` 中添加：
```env
# 腾讯云VOD配置
VOD_SECRET_ID=你的SecretId
VOD_SECRET_KEY=你的SecretKey
VOD_APP_ID=你的AppId
```

#### 3. 安装VOD SDK
```bash
npm install vod-node-sdk
```

#### 4. 创建视频上传页面
在 `/app/admin/courses/video-upload/page.tsx`：

```typescript
'use client';

import { useState } from 'react';
import { Upload, Video, Loader2 } from 'lucide-react';

export default function VideoUploadPage() {
  const [uploading, setUploading] = useState(false);
  const [progress, setProgress] = useState(0);
  const [videoUrl, setVideoUrl] = useState('');

  const handleUpload = async (file: File) => {
    setUploading(true);
    
    try {
      // 1. 获取上传签名
      const signRes = await fetch('/api/vod/signature');
      const { signature } = await signRes.json();
      
      // 2. 使用腾讯云SDK上传
      const VodUploader = (await import('vod-js-sdk-v6')).default;
      
      const uploader = new VodUploader({
        getSignature: () => signature
      });
      
      const result = await uploader.upload({
        mediaFile: file,
        onProgress: (info) => {
          setProgress(Math.floor(info.percent * 100));
        }
      });
      
      setVideoUrl(result.video.url);
      
      // 3. 保存到数据库
      await fetch('/api/courses/video', {
        method: 'POST',
        body: JSON.stringify({
          fileId: result.fileId,
          url: result.video.url,
          name: file.name,
          size: file.size,
          duration: result.video.duration
        })
      });
      
    } catch (error) {
      console.error('上传失败:', error);
    } finally {
      setUploading(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">上传教学视频</h1>
      
      <div className="bg-white rounded-lg shadow p-6">
        <input
          type="file"
          accept="video/*"
          onChange={(e) => e.target.files?.[0] && handleUpload(e.target.files[0])}
          className="hidden"
          id="video-upload"
        />
        
        <label htmlFor="video-upload" className="block cursor-pointer">
          <div className="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-blue-500 transition">
            {uploading ? (
              <>
                <Loader2 className="w-12 h-12 mx-auto mb-4 animate-spin text-blue-500" />
                <p>上传中... {progress}%</p>
              </>
            ) : (
              <>
                <Upload className="w-12 h-12 mx-auto mb-4 text-gray-400" />
                <p className="text-lg">点击或拖拽视频文件到此处</p>
                <p className="text-sm text-gray-500 mt-2">支持 MP4, MOV, AVI 等格式，最大 5GB</p>
              </>
            )}
          </div>
        </label>
        
        {videoUrl && (
          <div className="mt-6">
            <h3 className="font-semibold mb-2">上传成功！</h3>
            <video controls className="w-full rounded" src={videoUrl} />
            <input 
              type="text" 
              value={videoUrl} 
              readOnly 
              className="w-full mt-2 p-2 border rounded bg-gray-50"
            />
          </div>
        )}
      </div>
    </div>
  );
}
```

## 🎯 方案二：腾讯云COS存储

### 优势
- ✅ 配置简单
- ✅ 成本较低
- ✅ 适合中小型视频

### 配置步骤

#### 1. 开通COS服务
```bash
1. 登录腾讯云控制台
2. 创建存储桶（选择公有读私有写）
3. 获取SecretId、SecretKey和Bucket信息
```

#### 2. 更新上传接口
修改 `/app/api/upload/video/route.ts`：

```typescript
import COS from 'cos-nodejs-sdk-v5';

const cos = new COS({
  SecretId: process.env.COS_SECRET_ID,
  SecretKey: process.env.COS_SECRET_KEY,
});

export async function POST(request: NextRequest) {
  // ... 验证代码 ...
  
  const result = await cos.putObject({
    Bucket: process.env.COS_BUCKET,
    Region: process.env.COS_REGION,
    Key: `videos/${fileName}`,
    Body: buffer,
  });
  
  const videoUrl = `https://${process.env.COS_BUCKET}.cos.${process.env.COS_REGION}.myqcloud.com/videos/${fileName}`;
  
  return NextResponse.json({
    success: true,
    data: { url: videoUrl }
  });
}
```

## 💾 方案三：本地存储（仅开发使用）

### 当前已实现的功能
- 支持格式：MP4, WebM, OGG, MOV, AVI
- 最大文件：500MB
- 存储位置：`/public/uploads/videos/`

### 使用方法
```javascript
const formData = new FormData();
formData.append('file', videoFile);

const response = await fetch('/api/upload/video', {
  method: 'POST',
  body: formData
});
```

## 📚 将视频关联到课程

### 1. 更新课程数据结构
修改 `/lib/course-data.ts`：

```typescript
export interface Lesson {
  id: string;
  title: string;
  slug: string;
  type: 'video' | 'article' | 'wordpress' | 'quiz';
  content?: string;
  videoUrl?: string;        // 视频URL
  videoDuration?: number;   // 视频时长（秒）
  videoFileId?: string;     // VOD文件ID
  // ...
}
```

### 2. 在课程管理页面添加视频
创建 `/app/admin/courses/[sectionSlug]/[lessonSlug]/edit/page.tsx`

### 3. 视频播放器集成
推荐使用 Video.js：

```bash
npm install video.js @videojs/themes
```

在课程详情页使用：
```jsx
import videojs from 'video.js';
import 'video.js/dist/video-js.css';
import '@videojs/themes/dist/sea/index.css';

<video
  ref={videoRef}
  className="video-js vjs-theme-sea vjs-big-play-centered"
  controls
  preload="auto"
>
  <source src={lesson.videoUrl} type="video/mp4" />
</video>
```

## 🔧 实施步骤

### 第一步：选择方案
- 生产环境：使用腾讯云VOD
- 测试环境：使用本地存储

### 第二步：配置服务
1. 申请腾讯云账号
2. 开通VOD服务
3. 配置环境变量

### 第三步：实现上传功能
1. 创建上传页面
2. 实现进度显示
3. 添加错误处理

### 第四步：关联课程
1. 更新课程数据模型
2. 创建视频选择器
3. 实现播放功能

## 💡 最佳实践

1. **视频压缩**
   - 上传前使用 FFmpeg 压缩
   - 推荐码率：1080p 约 3Mbps

2. **用户体验**
   - 显示上传进度
   - 支持断点续传
   - 提供预览功能

3. **安全考虑**
   - 限制文件类型
   - 设置最大文件大小
   - 使用防盗链

4. **性能优化**
   - 使用CDN加速
   - 实现懒加载
   - 支持多清晰度切换

## 🚨 注意事项

1. **成本控制**
   - VOD按使用量计费
   - 建议设置用量告警
   - 定期清理无用视频

2. **备份策略**
   - 重要视频多地备份
   - 定期导出视频列表
   - 保留原始文件

3. **合规要求**
   - 视频内容审核
   - 版权保护措施
   - 用户隐私保护

需要我帮您实现具体哪个方案吗？