# 深海圈课程内容编辑器设计方案

## 一、需求分析

### 1.1 核心需求
- 支持从飞书文档复制粘贴图文混合内容
- 自动检测并上传剪贴板中的图片
- 保留文本格式（标题、列表、加粗等）
- 支持视频嵌入和管理
- 良好的编辑体验

### 1.2 用户场景
1. 老师从飞书文档复制课程内容
2. 直接粘贴到编辑器，图片自动上传
3. 可以继续编辑和调整格式
4. 预览效果后发布

## 二、技术方案对比

### 方案A：集成 TinyMCE（推荐）
**优势：**
- 最成熟的富文本解决方案
- 完善的图片粘贴上传支持
- 丰富的插件生态
- 良好的中文支持

**实现要点：**
```javascript
tinymce.init({
  selector: '#editor',
  language: 'zh_CN',
  automatic_uploads: true,
  paste_data_images: true,
  images_upload_handler: async (blobInfo) => {
    const formData = new FormData();
    formData.append('file', blobInfo.blob());
    const response = await fetch('/api/upload/image', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();
    return data.url;
  }
});
```

### 方案B：使用 Quill.js + 自定义模块
**优势：**
- 轻量级，性能优秀
- 易于定制和扩展
- 现代化的API设计

**实现要点：**
```javascript
const quill = new Quill('#editor', {
  modules: {
    clipboard: {
      matchers: [
        ['img', handleImagePaste]
      ]
    }
  }
});
```

### 方案C：开发类 Notion 块编辑器
**优势：**
- 最灵活的内容管理
- 每个块独立处理
- 适合复杂的课程结构

**劣势：**
- 开发成本高
- 用户学习成本大

## 三、推荐实施方案

### 3.1 短期方案（1-2周）
增强现有的 textarea，实现智能粘贴功能：

1. **监听粘贴事件**
   - 检测剪贴板内容类型
   - 提取HTML结构
   - 解析图片和文本

2. **图片处理流程**
   - 提取所有图片（base64或blob）
   - 批量上传到服务器
   - 替换为CDN链接
   - 显示上传进度

3. **格式转换**
   - HTML转Markdown（保留基本格式）
   - 自动识别标题级别
   - 保留列表和强调样式

### 3.2 中期方案（1个月）
集成专业富文本编辑器：

1. **选择 TinyMCE 6**
   - 申请免费社区版license
   - 配置中文语言包
   - 定制工具栏

2. **配置功能**
   - 图片自动上传
   - 视频嵌入支持
   - 表格编辑
   - 代码高亮

3. **优化体验**
   - 自动保存草稿
   - 历史版本管理
   - 全屏编辑模式

### 3.3 长期方案（3个月）
开发专属的课程编辑器：

1. **基于 Lexical 或 Slate.js**
2. **课程特色功能**
   - 知识点标注
   - 练习题嵌入
   - 学习进度追踪
3. **AI辅助功能**
   - 内容优化建议
   - 自动生成大纲

## 四、具体实现步骤

### 第一步：改进当前编辑器
```typescript
// 增强的粘贴处理器
interface PasteHandler {
  extractImages(html: string): Promise<ImageData[]>;
  uploadImages(images: ImageData[]): Promise<string[]>;
  processContent(html: string, imageUrls: string[]): string;
}

// 实现智能粘贴
const handleEnhancedPaste = async (event: ClipboardEvent) => {
  const html = event.clipboardData.getData('text/html');
  const images = await extractImages(html);
  
  // 显示上传进度
  showUploadProgress(images.length);
  
  // 批量上传
  const urls = await uploadImages(images);
  
  // 处理内容
  const processed = processContent(html, urls);
  
  // 插入到编辑器
  insertContent(processed);
};
```

### 第二步：集成富文本编辑器
```typescript
// TinyMCE 配置
export const editorConfig = {
  plugins: [
    'advlist', 'autolink', 'lists', 'link', 'image', 'charmap',
    'preview', 'anchor', 'searchreplace', 'visualblocks', 'code',
    'fullscreen', 'insertdatetime', 'media', 'table', 'wordcount'
  ],
  toolbar: '撤销 重做 | 格式 | 粗体 斜体 | 对齐 | 列表 | 图片 视频 | 预览',
  automatic_uploads: true,
  paste_data_images: true,
  images_upload_handler: customUploadHandler
};
```

## 五、数据存储设计

### 5.1 内容存储格式
```typescript
interface LessonContent {
  id: string;
  format: 'markdown' | 'html' | 'json';
  content: string;
  media: {
    images: ImageAsset[];
    videos: VideoAsset[];
  };
  metadata: {
    wordCount: number;
    readingTime: number;
    lastEdited: Date;
  };
}
```

### 5.2 媒体资源管理
- 图片：自动压缩、生成缩略图、CDN分发
- 视频：转码、生成预览图、流媒体播放

## 六、用户体验优化

### 6.1 编辑体验
- **实时预览**：分屏显示编辑和预览
- **快捷键支持**：Ctrl+S 保存，Ctrl+Z 撤销
- **自动保存**：每30秒自动保存草稿
- **离线编辑**：本地缓存，网络恢复后同步

### 6.2 粘贴优化
- **智能识别**：自动识别飞书、Word、网页内容
- **格式清理**：移除多余样式，保留核心格式
- **批量处理**：支持多图片同时上传
- **进度反馈**：显示上传进度和预计时间

## 七、技术栈建议

### 前端
- React + TypeScript
- TinyMCE 或 Lexical
- TanStack Query（数据管理）
- Zustand（状态管理）

### 后端
- 图片处理：Sharp
- 存储：腾讯云COS
- 视频：腾讯云VOD
- 缓存：Redis

## 八、实施计划

### 第1周：增强现有编辑器
- [ ] 实现智能粘贴功能
- [ ] 完成图片自动上传
- [ ] 添加上传进度提示

### 第2-3周：集成 TinyMCE
- [ ] 配置和定制编辑器
- [ ] 实现自动保存
- [ ] 添加媒体管理

### 第4周：优化和测试
- [ ] 性能优化
- [ ] 用户测试
- [ ] Bug修复

## 九、参考实现

可以参考以下开源项目：
1. [Outline](https://github.com/outline/outline) - 知识库编辑器
2. [Payload CMS](https://github.com/payloadcms/payload) - 现代CMS编辑器
3. [BlockNote](https://github.com/TypeCellOS/BlockNote) - 块编辑器

## 十、总结

推荐采用渐进式改进策略：
1. **立即改进**：增强现有textarea的粘贴功能
2. **短期集成**：使用TinyMCE提供专业编辑体验
3. **长期规划**：开发定制化的课程编辑器

这样既能快速解决当前问题，又为未来发展留有空间。