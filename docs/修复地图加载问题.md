# 修复地图加载问题

## 问题诊断
1. 地图一直显示"加载地图中..."
2. 缺少 tim-js-sdk 依赖
3. API 正常返回数据（200状态）

## 解决步骤

### 1. 安装缺失的依赖
```bash
# 安装 IM SDK（如果需要保留 IM 功能）
npm install tim-js-sdk

# 或者暂时禁用 IM 功能（推荐）
# 见步骤2
```

### 2. 临时禁用 IM 功能（推荐）
创建一个不依赖 tim-js-sdk 的 mock 版本：

```bash
# 备份原文件
mv hooks/useIM.ts hooks/useIM.ts.backup

# 创建 mock 版本
cat > hooks/useIM.ts << 'EOF'
export default function useIM() {
  return {
    isReady: false,
    login: () => Promise.resolve(),
    logout: () => Promise.resolve(),
    sendMessage: () => Promise.resolve(),
    onMessageReceived: () => {},
    onConversationUpdate: () => {},
    getConversationList: () => Promise.resolve([]),
    getMessageList: () => Promise.resolve([]),
  }
}
EOF
```

### 3. 检查地图组件加载
在浏览器控制台执行：
```javascript
// 检查是否有错误
console.log('Checking map errors...');

// 检查 ECharts 是否加载
console.log('ECharts loaded:', typeof window.echarts);

// 查看网络请求
// 打开 Network 标签，刷新页面，查看是否有失败的请求
```

### 4. 强制刷新页面
```bash
# Mac
Cmd + Shift + R

# Windows/Linux
Ctrl + Shift + F5
```

### 5. 如果地图还是不显示，检查 ECharts
```bash
# 确保 echarts 已安装
npm list echarts

# 如果没有安装
npm install echarts echarts-for-react
```

### 6. 重启开发服务器
```bash
# 停止当前服务 (Ctrl+C)
# 然后重新启动
npm run dev
```

## 验证步骤

1. 访问 http://localhost:3000/api/users/locations
   - 应该看到 JSON 数据

2. 访问 http://localhost:3000/map
   - 地图应该正常显示
   - 控制台不应有红色错误

## 快速修复命令（一键执行）
```bash
# 备份并创建 mock useIM
mv hooks/useIM.ts hooks/useIM.ts.backup 2>/dev/null || true
echo 'export default function useIM() {
  return {
    isReady: false,
    login: () => Promise.resolve(),
    logout: () => Promise.resolve(),
    sendMessage: () => Promise.resolve(),
    onMessageReceived: () => {},
    onConversationUpdate: () => {},
    getConversationList: () => Promise.resolve([]),
    getMessageList: () => Promise.resolve([]),
  }
}' > hooks/useIM.ts

# 确保 echarts 已安装
npm install echarts echarts-for-react --save

# 重启服务
npm run dev
```

## 如果还有问题

查看地图组件是否正确导入：
```bash
cat app/map/ChinaMap.tsx | head -20
```

确保动态导入配置正确：
- ssr: false（禁用服务端渲染）
- loading 组件正确显示